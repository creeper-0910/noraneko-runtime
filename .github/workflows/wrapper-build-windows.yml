# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.

name: "(A) âš’ Windows build"

on:
  workflow_dispatch:
    inputs:
      debug:
        type: boolean
        required: true
      pgo:
        type: boolean
        default: false
        required: true

  workflow_call:
    inputs:
      debug:
        type: boolean
        required: true
      pgo:
        type: boolean
        default: false
        required: true

run-name: ${{toJSON(inputs.pgo) == 'true' && '[PGO] ' || ''}}Windows x64 build${{toJSON(inputs.debug) == 'true' && ' Debug' || ''}}
jobs:
  part-1:
    name: Windows x64 build${{toJSON(inputs.debug) == 'true' && ' Debug' || ''}}
    uses: ./.github/workflows/common-build.yml
    with:
      platform: windows
      arch: x86_64
      debug: ${{inputs.debug}}
      profile-generate-mode: ${{ toJSON(inputs.pgo) == 'true' }}

  part-2:
    name: Windows x64 Generate Profile for Guided Optimization
    if: ${{ toJSON(inputs.pgo) == 'true' }}
    needs: part-1
    uses: ./.github/workflows/pgo-build.yml
    secrets: inherit
    with:
      browser-artifact-name: noraneko-win-amd64-profile-generate-mode-package
      artifact-path: C:\artifact
      runner: windows-latest
      target-arch: x86_64
      profile-mode: generate
      upload-artifact-name: noraneko-win-amd64-profile-generate-output

  part-3:
    name: Windows x64 build${{toJSON(inputs.debug) == 'true' && ' Debug' || ''}}
    if: ${{ toJSON(inputs.pgo) == 'true' }}
    needs: part-2
    uses: ./.github/workflows/common-build.yml
    with:
      platform: windows
      arch: x86_64
      debug: ${{inputs.debug}}
      pgo_artifact_name: noraneko-win-amd64-profile-generate-output
